# Индекс памяти проекта

Этот файл содержит ссылки на все файлы документации и служит точкой входа для понимания структуры проекта.

## Основные файлы документации

- [Журнал исправлений ошибок](planning/BUG_FIXES_LOG.md) - история исправлений и найденных ошибок
- [Справочники платформ и брокеров](planning/TRADING_PLATFORMS_BROKERS.md) - документация по справочникам платформ, брокеров и их серверов

## Структура плагина конкурсов

Плагин предназначен для управления конкурсами трейдеров и отображения информации о них.

### Ключевые файлы

- `contests/templates/archive-contests.php` - шаблон архивной страницы списка конкурсов
- `contests/templates/single-contest.php` - шаблон страницы отдельного конкурса
- `contests/templates/single-account.php` - шаблон страницы отдельного счета
- `contests/templates/trader-statistics.php` - шаблон страницы статистики трейдера
- `contests/public/class-contest-ajax.php` - обработчик AJAX-запросов для динамического обновления данных
- `contests/frontend/js/frontend.js` - клиентский JavaScript для обновления данных
- `contests/debug-prize-funds.php` - отладочный скрипт для проверки призовых фондов
- `contests/includes/class-disqualification-checker.php` - класс для проверки условий дисквалификации участников
- `contests/admin/import-members.php` - скрипт для импорта участников из старой системы в новую

### Импорт данных из старой системы

Для переноса данных из старой системы предусмотрены следующие скрипты:

1. **Импорт участников конкурсов** - файл `contests/admin/import-members.php`:
   - Импортирует информацию об участниках конкурсов из старых таблиц `ft_contest_member` и `ft_contest_member_stats`
   - Преобразует данные в формат новой системы и сохраняет в таблицу `wp_contest_members`
   - Доступен через административное меню "Конкурсы трейдеров > Импорт участников"
   - Позволяет выбрать конкурс из старой системы и соответствующий ему конкурс в новой системе
   - Поддерживает поэтапный импорт с настраиваемым количеством записей за один проход

### Механизм дисквалификации

Дисквалификация участников контролируется классом `Contest_Disqualification_Checker`, который проверяет следующие условия:

1. **Начальный депозит** - соответствие установленному для конкурса
2. **Кредитное плечо** - использование разрешенного плеча
3. **Инструменты** - использование только разрешенных инструментов
4. **Максимальный объем** - суммарный объем открытых позиций типа BUY и SELL не должен превышать максимальный
5. **Минимальное количество сделок** - необходимо совершить минимальное количество сделок
6. **Сделки до начала конкурса** - отсутствие сделок до официального старта конкурса
7. **Минимальная прибыль** - достижение минимально требуемой прибыли к концу конкурса

Важно отметить, что при проверке максимального объема учитываются только реальные открытые позиции (BUY и SELL), а лимитные и отложенные ордера (BUYLIMIT, SELLLIMIT, BUYSTOP, SELLSTOP) не учитываются.

### Хранение данных

1. Метаданные конкурсов хранятся в двух форматах:
   - Новый формат: в поле `_fttradingapi_contest_data` как структурированный массив
   - Старый формат: отдельные meta-поля (например, `_contest_prize_fund`)

2. Призовой фонд:
   - Новый формат: массив в `_fttradingapi_contest_data['prizes']`
   - Старый формат: значение в `_contest_prize_fund`
   
3. Дата начала конкурса хранится в трех возможных форматах:
   - Старый формат: мета-поле `_contest_start_date`
   - Новый формат 1: `_fttradingapi_contest_data['start_date']`
   - Новый формат 2: `_fttradingapi_contest_data['date_start']` (используется в админке)
   - Дополнительное поле для сортировки: `_contest_sorting_start_date` (содержит копию даты начала)

### Механизм сортировки конкурсов

Для сортировки конкурсов на странице архива используется следующий механизм:

1. **Вспомогательное мета-поле**: Для каждого конкурса создается вспомогательное поле `_contest_sorting_start_date`, которое содержит дату начала конкурса в стандартном формате независимо от исходного формата хранения.

2. **Обновление поля сортировки**:
   - При сохранении конкурса через функцию `fttradingapi_update_contest_sorting_field`
   - При массовом обновлении через функцию `fttradingapi_update_all_contest_sorting_fields`
   - Периодически на странице архива (не чаще раза в день)

3. **Сортировка на странице архива**:
   - Используется стандартный механизм WordPress для сортировки по мета-полю
   - Сортировка выполняется в порядке убывания (DESC) для отображения новых конкурсов вверху

4. **Оптимизация производительности**:
   - Массовое обновление полей сортировки выполняется не чаще одного раза в день
   - Используется переменная `fttradingapi_sorting_fields_last_update` для отслеживания времени последнего обновления

### Известные проблемы

1. ✅ Неверный подсчет общего призового фонда на странице списка конкурсов
   - **ИСПРАВЛЕНИЕ 1 (2023-11-29):** Добавлена поддержка обоих форматов хранения данных о призах в методе `update_contests_data()` в файле `class-contest-ajax.php`
   - **ИСПРАВЛЕНИЕ 2 (2023-11-30):** Исправлен шаблон `archive-contests.php` - добавлена отдельная переменная для хранения суммы призовых фондов всех конкурсов

2. ✅ Некорректная сортировка конкурсов на странице архива
   - **ИСПРАВЛЕНИЕ (2024-07-07):** Переработан механизм сортировки для учета всех форматов хранения даты начала конкурса

## База данных

Плагин использует следующие таблицы:

- `{prefix}_contest_members` - информация об участниках конкурсов
- `{prefix}_contest_members_order_history` - история сделок участников

## Функции и точки входа

- `update_contests_data()` - функция для обновления данных на странице архива конкурсов
- `calculate_contest_statistics()` - функция расчета статистики по конкурсу 
- `fttradingapi_sort_contests_by_start_date()` - функция для сортировки конкурсов по дате начала
- `fttradingapi_update_contest_sorting_field()` - функция обновления поля сортировки для конкурса
- `fttradingapi_add_trader_statistics_endpoint()` - регистрирует URL для страницы статистики трейдера
- `fttradingapi_load_trader_statistics_template()` - загружает шаблон страницы статистики трейдера

## Отладочные инструменты

- `contests/debug-prize-funds.php` - скрипт для проверки призовых фондов всех конкурсов, показывает детальную информацию о конкурсах, призовых местах и суммах 