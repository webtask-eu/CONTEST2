# Документация плагина для конкурсов трейдеров

## Обзор

Плагин предназначен для управления конкурсами трейдеров и отображения информации о них на сайте WordPress. Он позволяет:

1. Создавать и управлять конкурсами трейдеров
2. Регистрировать участников и их торговые счета
3. Отслеживать результаты в реальном времени
4. Отображать рейтинги и статистику участников

## Структура плагина

### Типы контента

1. **trader_contests** - кастомный тип записи для конкурсов
   - Метаданные: даты начала/окончания, призовой фонд, правила и т.д.

### Таблицы базы данных

1. **{prefix}_contest_members** - таблица для хранения информации об участниках
   - id - уникальный идентификатор участника
   - user_id - ID пользователя WordPress
   - contest_id - ID конкурса
   - account_login - логин торгового счета
   - equity - текущий капитал
   - balance - баланс счета
   - profit_percent - процент прибыли
   - currency - валюта счета
   - connection_status - статус подключения
   - last_update - время последнего обновления

2. **{prefix}_contest_members_order_history** - история сделок участников
   - id - уникальный идентификатор записи
   - account_id - ID участника из таблицы contest_members
   - order_id - ID сделки в торговой системе
   - symbol - торговый инструмент
   - type - тип сделки (buy, sell)
   - open_time - время открытия
   - close_time - время закрытия
   - volume - объем
   - open_price - цена открытия
   - close_price - цена закрытия
   - profit - прибыль/убыток

### Основные файлы и директории

- `contests/admin/` - функциональность административной панели
- `contests/includes/` - основные классы и функции
- `contests/public/` - публичная часть плагина, включая AJAX-обработчики
- `contests/templates/` - шаблоны для отображения страниц
  - `archive-contests.php` - список всех конкурсов
  - `single-contest.php` - страница отдельного конкурса

## Функциональность

### Отображение данных на странице архива конкурсов

Страница архива конкурсов (`/trader-contests/`) содержит:

1. Список всех конкурсов с возможностью фильтрации и сортировки
2. Общую статистику:
   - Общий призовой фонд - сумма призовых всех конкурсов
   - Количество участников - общее число участников во всех конкурсах
   - Активных конкурсов - количество текущих активных конкурсов

Эти данные вычисляются в `archive-contests.php` и могут обновляться через AJAX-запросы в `class-contest-ajax.php`.

### Данные о призовом фонде

Информация о призовом фонде хранится в двух форматах:

1. Старый формат - мета-поле `_contest_prize_fund` с общей суммой
2. Новый формат - структурированные данные в мета-поле `_fttradingapi_contest_data`:
   ```php
   [
       'prizes' => [
           [
               'place' => '1',
               'amount' => '$1000'
           ],
           [
               'place' => '2',
               'amount' => '$500'
           ],
           // ...
       ]
   ]
   ```

При подсчете общего призового фонда учитываются оба формата.

### AJAX-обновление данных

Функция `update_contests_data()` в классе `Contest_Public_Ajax` отвечает за обновление данных на странице архива конкурсов через AJAX. Она:

1. Подсчитывает общее количество участников
2. Вычисляет общий призовой фонд
3. Подсчитывает количество активных конкурсов
4. Получает данные о ТОП-5 лидерах

### Регистрация на конкурс

Пользователи могут регистрировать свои торговые счета на конкурс через форму регистрации. После регистрации:

1. Данные счета сохраняются в таблице `{prefix}_contest_members`
2. Устанавливается соединение с торговым API для получения информации о счете
3. Данные счета обновляются через регулярные запросы

## Механизмы обновления данных

### Обновление данных о счетах

1. **Автоматическое обновление** - через WP Cron
2. **Обновление через AJAX** - когда пользователь находится на странице конкурса
3. **Ручное обновление** - администратор может запустить обновление из админ-панели

### Расчет статистики

Функция `calculate_contest_statistics()` в классе `Contest_Public_Ajax` рассчитывает различные метрики для отображения на странице конкурса:

1. Количество сделок
2. Количество трейдеров в прибыли/убытке
3. Общую сумму прибыли/убытка
4. Соотношение прибыльных/убыточных трейдеров
5. Эффективность (win rate)

## API и интеграции

Плагин интегрируется с торговой платформой через API для получения данных о счетах и сделках в реальном времени.

## Безопасность

1. Все AJAX-запросы проверяются через nonce
2. Доступ к административным функциям контролируется через проверки прав пользователя
3. Данные, полученные от пользователя, валидируются и очищаются перед использованием

## Известные проблемы и их решения

1. **Неверный подсчет общего призового фонда** - исправлено через добавление поддержки обоих форматов хранения призовых фондов в методе `update_contests_data()`. 