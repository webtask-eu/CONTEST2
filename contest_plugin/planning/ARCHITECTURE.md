# Архитектура плагина Trading Contest

## Общая структура

Плагин Trading Contest построен по модульному принципу с разделением на административную и публичную части. Его архитектура позволяет легко расширять функциональность и поддерживать различные части кода.

## Основные компоненты

### 1. Типы записей (Post Types)

- **Конкурсы трейдеров (trader_contests)**
  - Основной тип записи для хранения информации о конкурсах
  - Метаданные хранятся в поле `_fttradingapi_contest_data`
  - Поддерживает стандартные функции WordPress: заголовок, содержимое, миниатюру

### 2. Таблицы базы данных

- **wp_contest_members** - информация об участниках и их счетах
- **wp_contest_members_orders** - текущие открытые ордера
- **wp_contest_members_order_history** - история закрытых ордеров
- **wp_contest_members_history** - история изменений различных полей счета

### 3. Административные классы

- **Class_Admin_Menu** - управление меню в админке
- **Class_Admin_Pages** - страницы администрирования
- **Class_Settings_Page** - страница настроек
- **Class_Accounts_List_Table** - таблица для отображения счетов

### 4. Фронтенд классы

- **Contest_Public** - публичная часть плагина
- **Contest_Ajax** - обработка AJAX-запросов с фронтенда

### 5. Утилитарные классы

- **Account_Trading_Metrics** - расчет торговых метрик
- **Account_Chart_Data** - подготовка данных для графиков
- **Account_History** - работа с историей счетов
- **Account_Updater** - обновление данных счетов
- **API_Handler** - работа с внешним API
- **Cron_Manager** - управление задачами по расписанию

## Интеграция с WordPress

Плагин интегрируется со стандартными возможностями WordPress:

1. **Хуки и фильтры**
   - `init` - регистрация типа записи
   - `admin_menu` - добавление пунктов меню
   - `admin_enqueue_scripts` - подключение скриптов и стилей
   - `save_post` - сохранение метаданных
   - `post_row_actions` - модификация действий для записей
   - `wp_ajax_*` - обработка AJAX-запросов

2. **Метабоксы**
   - Основные данные
   - Настройки
   - Условия
   - Призовые места

3. **Шорткоды**
   - `[contest_registration_form]` - форма регистрации в конкурсе
   - `[contest_leaderboard]` - таблица лидеров конкурса

## Поток данных

1. **Регистрация аккаунта**
   - Пользователь регистрирует торговый счет
   - Данные сохраняются в таблице `wp_contest_members`
   - Производится проверка подключения через API

2. **Обновление данных счетов**
   - Cron-задание запускает процесс обновления
   - API_Handler получает актуальные данные
   - Account_Updater обновляет данные в БД
   - История изменений сохраняется

3. **Отображение данных**
   - Данные из БД преобразуются в формат для отображения
   - Account_Chart_Data готовит данные для графиков
   - Account_Trading_Metrics рассчитывает показатели

## Функциональность копирования конкурса

Реализация функциональности копирования конкурса основана на стандартных механизмах WordPress:

1. **Добавление кнопки действия**
   - Фильтр `post_row_actions` используется для добавления кнопки "Копировать"
   - Кнопка добавляется только для записей типа "trader_contests"
   - URL содержит параметры action=duplicate_contest и ID записи
   - Добавлен nonce для безопасности

2. **Обработка запроса на копирование**
   - Хук `admin_init` используется для перехвата запроса
   - Проверяется nonce и права пользователя
   - Создается новый пост с копией данных исходного
   - Копируются все метаданные и миниатюра
   - Производится редирект на страницу редактирования нового конкурса

3. **Схема потока данных при копировании**
   ```
   Клик на "Копировать" → fttradingapi_handle_duplicate_contest() → 
   Проверка прав → Копирование данных → Редирект на редактирование
   ```

## Расширение функциональности

Плагин спроектирован для легкого расширения. Для добавления новых функций рекомендуется:

1. Создавать отдельные классы для новой функциональности
2. Использовать хуки и фильтры WordPress для интеграции
3. Следовать принципам ООП для поддержания модульности
4. Документировать код для облегчения дальнейшей поддержки 