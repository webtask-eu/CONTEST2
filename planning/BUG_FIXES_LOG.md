# Лог исправлений (BUG_FIXES_LOG.md)

Этот файл содержит историю исправленных ошибок и внесенных изменений в проект CONTEST2.

## Формат записей

Каждая запись должна содержать:
- **Дата**: Дата исправления
- **Версия/Компонент**: Версия или компонент, где была ошибка
- **Описание ошибки**: Краткое описание проблемы
- **Решение**: Описание внесенных исправлений
- **Ответственный**: Кто внес исправление

---

## 24.04.2023 - Исправление проблемы с определением статуса подключения

### Проблема
Плагин показывал, что счет подключен (статус "connected"), но финансовые показатели были нулевыми. Это происходило из-за того, что API возвращало статус "connected" даже при отсутствии ключевых данных.

### Лог ошибки
```
[24-Apr-2025 22:55:22 UTC] [ACCOUNT-HISTORY] Получены данные для истории account_id=63: 
old_data={"i_bal":"40934.63","i_equi":"52163.13","i_marg":"18879.51","i_prof":"11228.50","i_level":"50.00","i_ordtotal":"5","i_firma":"Tickmill Ltd","i_fio":"Leanid Kasareuski","i_dr":"demo","connection_status":"connected","error_description":""}, 
new_data={"aid":"","stat":"0","login":"20250024","pass":"hE8_+@YNIgu=","srvMt4":"Tickmill-Demo","sGmt":"-3","time_last_update":"1745421047","last_logMt4":"2350\/220","i_server":"","i_firma":"","i_fio":"","i_cur":"","i_dr":"real","i_bal":0,"i_equi":0,"i_marg":0,"i_prof":0,"i_level":0,"i_ordtotal":0,"h_count":"0","s_newrev":"1","__pack":"1","connection_status":"connected","error_description":""}
```

### Решение
Улучшена функция `convertToJsonFormat()` в файле `WEBAPI/api_json_wp.php`. Добавлены проверки на:
1. Наличие имени пользователя (поле `i_fio`)
2. Наличие названия брокера (поле `i_firma`)
3. ~~Ненулевые значения финансовых показателей (поля `i_bal`, `i_equi`)~~ **(ОБНОВЛЕНО)**

**Обновление от 24.04.2023**:
После дополнительного уточнения процесса работы с API, было замечено, что баланс и средства могут быть равны нулю в некоторых сценариях (например, для новых счетов). Изменена логика проверки:
1. Проверяется только наличие полей `i_bal` и `i_equi` в ответе, но не их значения.
2. Основной причиной отключения является отсутствие поля `i_fio`.

Если отсутствуют обязательные поля, статус подключения устанавливается как "disconnected" с соответствующим описанием ошибки.

### Технические детали
1. Добавлен детальный лог ошибки с перечислением отсутствующих полей
2. Сохраняется информация о причине отключения в поле `error_description`
3. Статус "connected" теперь устанавливается только при наличии всех необходимых данных

### Автор исправления
Исправление внесено: 24.04.2023 

## 25.04.2023 - Доработка серверной части Python API для проверки полноты данных

### Проблема
При взаимодействии с терминалом MT4 иногда возвращаются неполные данные с пустыми полями (`i_fio`, `i_firma`), но со статусом подключения "connected", что приводит к ошибкам отображения в плагине. 

### Решение
Доработана серверная часть Python API для более тщательной проверки полноты данных и предотвращения преждевременной отправки неполных данных клиенту.

Изменения внесены в следующие файлы:

1. **SERVERAPI/app/mt4_handler.py**:
   - Добавлена функция `log_account_data_state` для подробного логирования состояния данных
   - Увеличено время ожидания инициализации MT4 с 10 до 15 секунд
   - Добавлена проверка полноты данных перед возвратом результата
   - Реализован механизм повторных попыток (до 5) получения полных данных
   - Добавлены новые поля `incomplete_data` и `missing_fields` для информирования клиента
   - Модифицирована функция `update_latest_data` для предотвращения перезаписи существующих данных

2. **SERVERAPI/app/routes.py**:
   - Добавлена обработка неполных данных в ответе API
   - Добавлены HTTP-заголовки `X-Data-Status` и `X-Missing-Fields` для информирования клиента

### Технические детали
1. При обнаружении неполных данных система делает до 5 дополнительных попыток с интервалом 5 секунд
2. Проверка фокусируется на наличии полей `i_fio`, `i_firma`, `i_bal` и `i_equi`
3. Даже если данные неполные, они возвращаются клиенту, но с дополнительными полями и заголовками
4. Ведется детальное логирование для каждой попытки получения данных

### Автор исправления
Исправление внесено: 25.04.2023 

## 05.05.2023 - Исправление отображения типов отложенных ордеров

### Проблема
В плагине для отображения открытых позиций (ордеров) с MT4 некорректно отображались типы отложенных ордеров - buylimit, selllimit, buystop, sellstop. Все они отображались как "UNKNOWN" во фронтенде плагина, хотя в терминале MT4 тип ордера отображался корректно.

### Лог ошибки
В терминале MT4 ордера имели типы "selllimit" и "buystop", но в плагине отображались как "UNKNOWN".

```
Открытые позиции
Тикет	Символ	Тип	Объем	Время открытия	Цена	S/L	T/P	Прибыль
200473127	XAUUSD	UNKNOWN	0.50	05.05.2025 08:10:47	0.00000	0.00000	0.00000	0.00 USD
200473062	XAUUSD	UNKNOWN	0.50	05.05.2025 08:10:34	0.00000	0.00000	0.00000	0.00 USD
```

### Решение
Исправлены следующие файлы:

1. **MT4CONTESTSCRIPT/AccountInfoExport2.mq4**:
   - Заменен упрощенный код определения типа ордера на полный switch-case блок
   - Добавлена корректная обработка типов ордеров: OP_BUYLIMIT, OP_SELLLIMIT, OP_BUYSTOP, OP_SELLSTOP
   - Старая версия кода работала только с OP_BUY и OP_SELL, игнорируя отложенные ордера

2. **PLUGIN/contests/templates/single-account.php**:
   - Добавлена поддержка типов buylimit, selllimit, buystop, sellstop для их правильного стилевого отображения
   - Создан список типов ордеров 'buy_types' и 'sell_types' для правильного применения стилей

3. **PLUGIN/contests/admin/class-admin-pages.php**:
   - Аналогичные изменения в административной части плагина
   - Добавлена проверка на принадлежность типа ордера к группам buy или sell

4. **WEBAPI/api.php**:
   - Добавлена обработка типов отложенных ордеров с присвоением правильных числовых кодов

### Технические детали
1. Сопоставление типов в MT4:
   - OP_BUY (0) => "buy"
   - OP_SELL (1) => "sell"
   - OP_BUYLIMIT (2) => "buylimit"
   - OP_SELLLIMIT (3) => "selllimit"
   - OP_BUYSTOP (4) => "buystop"
   - OP_SELLSTOP (5) => "sellstop"

2. Сопоставление типов в Web API:
   - "buy" => 0
   - "sell" => 1
   - "buylimit" => 2
   - "selllimit" => 3
   - "buystop" => 4
   - "sellstop" => 5
   - "balance" => 6
   - "credit" => 7
   - "rebate" => 8

### Автор исправления
Исправление внесено: 05.05.2023

## 05.05.2023 - Дополнительное исправление для поддержки отложенных ордеров в API JSON

### Проблема
Обнаружено, что файл `api_json_wp.php`, используемый для WordPress API, не обрабатывал правильно отложенные ордера (buylimit, selllimit, buystop, sellstop). В отличие от остальных частей системы, которые были исправлены ранее, этот файл просто передавал тип ордера без валидации.

### Решение
Дополнительно к исправлениям, сделанным в MT4 скрипте и фронтенде, внесены изменения в `WEBAPI/api_json_wp.php`:

1. Добавлена проверка типов ордеров на валидность
2. Создан список допустимых типов: 'buy', 'sell', 'buylimit', 'selllimit', 'buystop', 'sellstop', 'balance', 'credit', 'rebate'
3. Если тип ордера не распознан, он помечается как 'unknown'
4. Эта логика применена как для открытых ордеров, так и для истории сделок

### Технические детали
Главное изменение было внесено в функцию `convertToJsonFormat()`, которая преобразует данные из Python API в формат, понятный WordPress плагину. Добавлен конвертер типов для обоих массивов `open_orders` и `order_history`.

### Автор исправления
Исправление внесено: 05.05.2023

## 29.05.2023 - Исправление обработки полей цен открытия и закрытия сделок

### Проблема
В системе обнаружено несоответствие имен полей для цен открытия и закрытия сделок между скриптом MT4 и серверной обработкой. MT4 скрипт передавал данные в полях `open_price` и `close_price`, в то время как серверный API ожидал их в полях `openprice` и `closeprice`. Это приводило к отсутствию или некорректному отображению цен сделок в интерфейсе.

### Лог ошибки
MT4 скрипт отправлял данные в формате:
```json
{
  "open_price": "1234.56",
  "close_price": "1235.67"
}
```

Но серверный API ожидал:
```json
{
  "openprice": "1234.56",
  "closeprice": "1235.67"
}
```

Из-за этого несоответствия, цены не отображались или сбрасывались на значение по умолчанию (0).

### Решение
Внесены изменения в файлы обработки API для поддержки обоих вариантов имен полей:

1. **WEBAPI/api_json_wp.php**:
   - Добавлена проверка наличия полей `open_price` и `close_price`
   - Реализована поддержка как исходных полей (`openprice`, `closeprice`), так и полей, передаваемых от MT4 (`open_price`, `close_price`)
   - Добавлены комментарии для объяснения изменений

2. **WEBAPI/api.php**:
   - Аналогичные изменения для другого API файла
   - Использование тернарных операторов для проверки обоих вариантов имен полей

### Технические детали
Для обеспечения обратной совместимости реализован механизм, который сначала проверяет наличие полей в формате `open_price`/`close_price`, а если они отсутствуют, ищет поля в формате `openprice`/`closeprice`.

Пример нового кода:
```php
'openprice' => $order['open_price'] ?? $order['openprice'] ?? 0,
'closeprice' => $order['close_price'] ?? $order['closeprice'] ?? 0,
```

### Автор исправления
Исправление внесено: 29.05.2023

## 2023-05-13: Некорректная обработка статуса "disconnected"

### Описание проблемы
В API-сервере при получении статуса "Disconnected" от терминала MT4, система неправильно увеличивала счетчик таймаутов, хотя отключение и таймаут - это разные ситуации. Это приводило к необоснованному учету отключений как таймаутов и потенциально к ненужным перезагрузкам сервера.

### Выполненные изменения
- Убраны вызовы функции `increment_timeout_counter()` в функции `start_mt4` модуля `mt4_handler.py` при обработке статуса "disconnected"
- Оставлены вызовы `increment_timeout_counter()` только для реальных таймаутов - когда MT4 не отвечает более 60 секунд

### Файлы
- `/Users/asl/Documents/IT_FRILANCE/CONTEST2/SERVERAPI/app/mt4_handler.py`

### Результат
Теперь система корректно различает статусы "disconnected" (отключение) и "timeout" (таймаут), учитывая таймауты только при реальном отсутствии ответа от MT4 в течение длительного времени.

## 2023-05-13: Отключение попыток переподключения в MT4 скрипте

### Описание проблемы
При параллельных запусках MT4 терминалов система начинала работать медленно, так как MT4 скрипт пытался выполнить несколько попыток переподключения (до 3-х) при потере соединения. Это создавало дополнительную нагрузку на сервер и приводило к параллельному выполнению множества попыток переподключения.

### Выполненные изменения
- Изменено значение переменной `max_reconnect_attempts` с 3 на 0 для полного отключения попыток переподключения
- Модифицированная функция `TryReconnect()`, чтобы она немедленно сообщала об ошибке подключения без попыток переподключения

### Файлы
- `/Users/asl/Documents/IT_FRILANCE/CONTEST2/MT4CONTESTSCRIPT/AccountInfoExport2.mq4`

### Результат
Теперь при потере соединения MT4 скрипт сразу отправляет сообщение об ошибке подключения и завершает работу, не создавая дополнительную нагрузку на сервер из-за попыток переподключения.

## 2023-05-13: Оптимизация архитектуры API - удаление промежуточного слоя WebAPI

### Описание проблемы
Система имела сложную архитектуру с избыточным промежуточным слоем:
1. WordPress плагин делал запрос к WebAPI (tradingapi.intellarax.com)
2. WebAPI делал запрос к SERVERAPI
3. SERVERAPI запускал MT4, получал данные и возвращал их в WebAPI
4. WebAPI передавал данные обратно в WordPress плагин

Эта цепочка создавала дополнительные задержки, потенциальные точки отказа и усложняла диагностику проблем.

### Выполненные изменения
1. В SERVERAPI добавлен модуль `direct_api.py`, который эмулирует функциональность WebAPI:
   - Реализован маршрут `/api_json_wp.php` с той же сигнатурой, что и в WebAPI
   - Добавлена конвертация данных в совместимый с WordPress формат
   - Добавлена поддержка CORS для разрешения кросс-доменных запросов

2. В WordPress плагин добавлена возможность выбора режима подключения:
   - Создан класс `FT_API_Config` для управления настройками соединения
   - Добавлена страница настроек в админ-панель WordPress
   - Реализована проверка соединения с SERVERAPI
   - Модифицирован `class-api-handler.php` для использования нового режима

### Файлы
- `/Users/asl/Documents/IT_FRILANCE/CONTEST2/SERVERAPI/app/direct_api.py` (новый)
- `/Users/asl/Documents/IT_FRILANCE/CONTEST2/SERVERAPI/app/__init__.py` (модифицирован)
- `/Users/asl/Documents/IT_FRILANCE/CONTEST2/PLUGIN/contests/includes/class-api-config.php` (новый)
- `/Users/asl/Documents/IT_FRILANCE/CONTEST2/PLUGIN/contests/includes/class-api-handler.php` (модифицирован)
- `/Users/asl/Documents/IT_FRILANCE/CONTEST2/SERVERAPI/requirements.txt` (добавлен flask-cors)

### Результат
- Упрощение архитектуры системы - WordPress плагин теперь может обращаться напрямую к SERVERAPI, минуя промежуточный слой WebAPI
- Уменьшение задержек - меньше сетевых переходов и преобразований данных
- Повышение надежности - удалена одна из потенциальных точек отказа
- Гибкость - система поддерживает оба режима работы (прямой и через WebAPI) с возможностью переключения через админ-панель

## 2023-05-13: Исправление ошибки импорта функции get_config

### Описание проблемы
При запуске SERVERAPI возникала ошибка импорта функции `get_config` из модуля `app.config`:
```
ImportError: cannot import name 'get_config' from 'app.config' (C:\m4\app\config.py)
```

В файле `__init__.py` был импорт `from .config import get_config`, но такая функция отсутствовала в модуле `config.py`.

### Выполненные изменения
- Добавлена функция `get_config()` в файл `config.py`, которая возвращает словарь с параметрами конфигурации приложения
- Функция предоставляет доступ ко всем настройкам приложения из одного места

### Файлы
- `/Users/asl/Documents/IT_FRILANCE/CONTEST2/SERVERAPI/app/config.py`

### Результат
- Исправлена ошибка импорта при запуске приложения
- Улучшена организация кода - все параметры конфигурации теперь доступны через единый интерфейс
- Повышена надежность инициализации приложения

## 2023-06-02: Контроль одновременных запросов к API для предотвращения перегрузки системы

### Описание проблемы
При массовом обновлении данных счетов конкурсов система выполняла слишком много одновременных запросов к API, что приводило к перегрузке сервера, замедлению работы и потенциальным сбоям. Это особенно проявлялось при параллельном обновлении нескольких конкурсов или при большом количестве одновременных пользователей.

### Анализ проблемы
1. Отсутствовал механизм ограничения количества одновременных запросов к API
2. Все запросы обрабатывались параллельно без учета нагрузки на систему
3. При массовом обновлении счетов сервер не успевал обрабатывать запросы
4. Отсутствовал механизм отслеживания и сброса "зависших" запросов

### Выполненные изменения
1. Добавлен механизм контроля одновременных запросов в класс `FT_API_Config`:
   - Метод `can_send_request()` - проверяет возможность отправки нового запроса
   - Метод `request_completed()` - отмечает запрос как завершенный
   - Метод `reset_active_requests()` - сбрасывает счетчик активных запросов

2. Модифицированная функция `process_trading_account()` в файле `class-api-handler.php`:
   - Добавлена проверка возможности отправки запроса перед обращением к API
   - Добавлено освобождение слота запроса после получения ответа
   - Добавлена обработка исключений с гарантированным освобождением слота

3. Добавлена страница настроек API с параметром ограничения запросов:
   - Максимальное количество одновременных запросов (по умолчанию 2)
   - Отображение текущего количества активных запросов
   - Кнопка сброса счетчика на случай зависания запросов

### Файлы
- `PLUGIN/contests/includes/class-api-config.php` - добавлены методы контроля запросов и настройки
- `PLUGIN/contests/includes/class-api-handler.php` - модифицирована функция обработки запросов

### Результат
- Ограничение количества одновременных запросов к API предотвращает перегрузку системы
- Пользователи получают понятное сообщение о необходимости подождать при достижении лимита запросов
- Администраторы могут изменять лимит запросов в зависимости от мощности сервера
- Система стала более стабильной при массовом обновлении данных счетов

## 13.05.2023 - Устранение проблемы с зависшими очередями обновления счетов

### Описание проблемы
Система отображала несколько параллельных процессов обновления счетов в статусе "Выполняется", которые фактически зависли и не завершались корректно. Очереди могли оставаться в этом состоянии бесконечно, блокируя новые обновления.

### Анализ причин
1. При обрыве соединения с API или другой ошибке процесс обновления не завершался корректно
2. Счетчик активных API-запросов (ft_active_requests) не сбрасывался при ошибках
3. Отсутствовал механизм для администратора сбросить зависшие очереди вручную

### Реализованные решения
1. **Кнопка "Сбросить все очереди"** на странице списка счетов:
   - Добавлена кнопка в блок статуса очередей обновления
   - Реализован AJAX-обработчик `clear_all_update_queues`
   - Кнопка очищает все очереди и сбрасывает счетчик активных API-запросов

2. **Страница "Управление очередями"**:
   - Создана отдельная страница в меню "Конкурсы"
   - Показывает статус всех активных очередей и позволяет их сбросить
   - Отображает текущее значение счетчика активных API-запросов

3. **Скрипт reset-queues.php**:
   - Создан отдельный скрипт для прямого доступа через браузер
   - Не требует входа в административную панель WordPress
   - Сбрасывает счетчик API-запросов и все очереди обновления

### Технические детали
1. Функция `Account_Updater::clear_all_queues()` оптимизирована для более эффективной очистки
2. Добавлен метод `FT_API_Config::reset_active_requests()` для сброса счетчика активных запросов
3. Все изменения в системе сопровождаются логированием для отладки

### Связанные файлы
- class-api-handler.php - добавлен AJAX-обработчик
- class-admin-pages.php - добавлен класс Admin_Pages и страница управления очередями
- update-queue-status.php - добавлена кнопка сброса очередей
- reset-queues.php - добавлен скрипт для сброса очередей напрямую

## 15.05.2023 - Оптимизация обработки запросов MT4 и управление серверной нагрузкой

### Проблема
При высокой нагрузке на сервер наблюдаются множественные тайм-ауты и ошибки подключения к MT4 терминалам. В логах видны ошибки вида:

```
Server response: receive response failed [12002]
No real data received within 60 seconds during first phase
start_mt4 function timed out
```

Одновременно с этим очередь задач на сервере растёт до опасных значений:

```
WARNING: Task queue depth is 24
WARNING: Task queue depth is 25
...
WARNING: Task queue depth is 38
```

Это приводит к тому, что даже при корректной работе MT4 терминала и формировании правильных данных о счёте, эти данные не попадают на сервер из-за перегрузки сервера или сетевых ошибок.

### Анализ проблемы
1. **Перегрузка очереди задач** - сервер пытается обрабатывать больше запросов, чем может обработать
2. **Слишком много параллельных MT4 процессов** - одновременный запуск множества MT4 терминалов создаёт избыточную нагрузку
3. **Недостаточная обработка сетевых ошибок** - скрипт MT4 не имеет эффективных механизмов повторных попыток при ошибках отправки данных
4. **Фиксированный тайм-аут сервера** - сервер ждёт данные ровно 60 секунд, что недостаточно при высокой нагрузке

### Решение
1. **Ограничение одновременных запросов**:
   - Добавлен механизм динамического ограничения запросов в зависимости от текущей нагрузки
   - Максимальное количество одновременно работающих MT4 терминалов ограничено до 5 (настраиваемый параметр)
   - Превышающие лимит запросы ставятся в очередь ожидания с приоритетами

2. **Оптимизация процесса запуска MT4**:
   - Добавлено пошаговое логирование для отслеживания фаз инициализации MT4
   - Оптимизирован процесс проверки запущенных терминалов для уменьшения потребления ресурсов
   - Добавлен эффективный механизм повторного использования подключенных терминалов

3. **Улучшение обработки ошибок**:
   - В MT4 скрипт добавлен механизм экспоненциальной задержки при повторных попытках отправки данных
   - Добавлена детальная диагностика сетевых ошибок с проверкой всех фаз соединения
   - Реализован механизм сохранения данных для отложенной отправки при недоступности сервера

4. **Оптимизация очереди задач**:
   - Введён механизм приоритезации запросов (срочные обновления имеют высший приоритет)
   - Добавлена автоматическая очистка устаревших запросов из очереди
   - Реализован контроль глубины очереди с автоматическим отклонением новых запросов при критической глубине

Эти изменения позволяют системе эффективно справляться с пиковыми нагрузками, предотвращают перегрузку сервера и значительно повышают стабильность получения данных от MT4 терминалов.

## 15.05.2023 - Оптимизация задержки между получением данных от API и их отображением

### Проблема
При обновлении данных счета наблюдается задержка около 5 секунд между моментом, когда сервер отдает данные, и моментом их фактического отображения на фронтенде или в админке.

### Анализ проблемы
После изучения кода были выявлены следующие потенциальные причины задержки:

1. Задержка при обновлении страницы после получения ответа от API:
   - В `frontend.js` и `admin.js` используется `setTimeout` с задержкой 1000-2000 мс перед перезагрузкой страницы
   - Это создает ненужную задержку между получением данных и их отображением

2. Избыточная обработка данных на сервере после API-запроса:
   - Проверки дисквалификации и расчеты процентных соотношений выполняются синхронно после получения данных
   - Обработка истории аккаунта требует дополнительных запросов к БД

3. Отсутствие асинхронного обновления контента на фронтенде:
   - Вместо частичного обновления данных используется полная перезагрузка страницы
   - Нет механизма для обновления только измененных частей интерфейса

### Решение
Были внесены следующие изменения для оптимизации задержки:

1. **Уменьшение задержки таймера перезагрузки страницы:**
   - В файле `PLUGIN/contests/frontend/js/frontend.js` — уменьшен таймер с 1500мс до 500мс
   - В файле `PLUGIN/contests/admin/js/admin.js` — аналогичное уменьшение таймера

2. **Добавление асинхронного обновления данных на странице:**
   - Во фронтенд добавлен механизм обновления важных данных без перезагрузки страницы
   - Реализовано обновление баланса, эквити и статуса подключения через AJAX без перезагрузки страницы

3. **Оптимизация серверной обработки:**
   - Добавлен механизм отложенной обработки статистики и истории
   - Оптимизирован процесс проверки условий дисквалификации для уменьшения задержки

Эти изменения позволяют отображать обновленные данные практически сразу после получения ответа от API, без необходимости полной перезагрузки страницы.

## 15.05.2023 - Исправление дублирования запросов при обновлении счета из админки

### Проблема
При обновлении данных счета из административной панели WordPress (на странице просмотра счета) происходило дублирование запросов к API. В логах сервера это выглядело следующим образом:

```
[20254427] 15.05 13:39:28 INFO: Handling WP API
[20254427] 15.05 13:39:28 INFO: Handling WP API
[20254427] 15.05 13:39:29 INFO: Copied directory
[20254427] 15.05 13:39:29 INFO: INI created
[20254427] 15.05 13:39:29 INFO: History created
[20254427] 15.05 13:39:29 INFO: Copied directory
[20254427] 15.05 13:39:29 INFO: INI created
[20254427] 15.05 13:39:29 INFO: History created
[20254427] 15.05 13:39:29 INFO: Process started
[20254427] 15.05 13:39:29 INFO: Process started
```

Проблема была связана с тем, что JavaScript-обработчик кнопки обновления счета допускал повторные клики до завершения предыдущего запроса. Это приводило к запуску двух параллельных процессов обновления счета, что увеличивало нагрузку на сервер и могло вызывать нестабильность в работе системы.

### Решение
Улучшен JavaScript-обработчик кнопки обновления счета в файле `PLUGIN/contests/admin/js/admin.js`:

1. Добавлена дополнительная защита от двойных кликов - проверка флага `updating` у кнопки
2. При запуске обновления на кнопку устанавливается класс `updating`
3. Повторные клики игнорируются до завершения текущего запроса
4. Добавлено логирование попыток дублирования запросов
5. При завершении запроса (как успешном, так и с ошибкой) флаг обновления снимается

Изменения гарантируют, что только один запрос обновления счета может быть запущен в один момент времени, что предотвращает дублирование запросов к API и снижает нагрузку на сервер.

## 15.05.2023 - Исправление ошибки отображения при разрыве соединения с MT4 (обновление)

### Проблема
При запросе обновления счета с фронтенда, в случае ошибки подключения к MT4 (статус "disconnected"), плагин выдавал ошибку "Отсутствуют необходимые финансовые данные: i_bal, i_equi, i_marg, i_prof, leverage" вместо сообщения о проблеме с подключением. Кроме того, техническое сообщение об ошибке сохранялось в базе данных, что приводило к его отображению в информации о счете.

### Лог ошибки
```
[20254026] 15.05 13:04:09 INFO: Handling WP API
[20254026] 15.05 13:04:09 INFO: Copied directory
[20254026] 15.05 13:04:09 INFO: INI created
[20254026] 15.05 13:04:09 INFO: History created
[20254026] 15.05 13:04:09 INFO: Process started
[20254026] 15.05 13:04:14 INFO: Handling request
[20254026] 15.05 13:04:14 INFO: Disconnected status
[20254026] 15.05 13:04:14 INFO: Process terminated
[20254026] 15.05 13:04:14 INFO: Temp dir removed
[20254026] 15.05 13:04:14 INFO: Terminal closed
[20254026] 15.05 13:04:24 INFO: Request completed
```

### Решение
1. Исправлена логика обработки ответа API в файле `PLUGIN/contests/includes/class-api-handler.php`:
   - Изменен порядок проверок: проверка статуса подключения теперь имеет наивысший приоритет
   - При статусе подключения "disconnected" всегда выдается ошибка о проблеме подключения, а не об отсутствии финансовых данных
   - Расширено информационное сообщение об ошибке с подробными рекомендациями по устранению проблемы
   - **Улучшено:** Заменено техническое сообщение об отсутствии финансовых данных в базе данных на информативное сообщение о проблеме подключения

2. Добавлена обработка ошибок в методах обновления счета на фронтенде:
   - В `update_contest_account_data()` в файле `PLUGIN/contests/public/class-contest-ajax.php` добавлена проверка на наличие ошибки о финансовых данных и замена её на понятное сообщение об ошибке подключения
   - В `update_account_frontend()` добавлена аналогичная проверка для обеспечения согласованности сообщений об ошибках
   - Добавлено логирование для отладки и отслеживания проблемы

Благодаря этим изменениям пользователь всегда получает понятное сообщение об ошибке подключения с рекомендациями по её устранению, а не техническую информацию об отсутствии финансовых данных. Теперь и в базе данных сохраняется полезная информация об ошибке, которая отображается в интерфейсе пользователя.

## 2025-05-15: Улучшение механизма восстановления соединения между MT4 и сервером

### Проблема
MT4 скрипт (AccountInfoExport2) иногда терял соединение с сервером и не мог автоматически восстановить связь. В логах наблюдались сообщения вида:
```
2025.05.15 15:42:15.315: Connection Error: Connection lost. Reconnect disabled.
2025.05.15 15:42:31.330: Server response: receive response failed [12002]
```

### Решение
1. Внедрен механизм автоматического переподключения с настраиваемыми параметрами:
   - Добавлены параметры: `RECONNECT_ATTEMPTS`, `RECONNECT_DELAY`, `ENABLE_AUTO_RECONNECT`
   - Реализовано экспоненциальное увеличение задержки между попытками
   - Добавлен heartbeat механизм для проверки состояния соединения

2. На стороне сервера (Flask) добавлен новый эндпоинт `/heartbeat` для обработки проверочных запросов от MT4

3. Добавлена более подробная обработка ошибок соединения и информативное логирование

## 2025-05-16: Внедрение балансировки нагрузки для одновременной работы нескольких терминалов MT4

### Проблема
При работе нескольких терминалов MT4 одновременно наблюдались проблемы с подключением к серверу из-за ограничений WebRequest в MT4. В логах появлялись ошибки:
```
2025.05.15 15:56:04.721: Heartbeat failed. Response code: -1
2025.05.15 15:56:06.924: Reconnection attempt 3/5
```

Это связано с ограничением WebRequest в MT4 (максимум 2-5 одновременных соединений).

### Решение
1. Внедрена архитектура с балансировкой нагрузки:
   - Разработан механизм запуска нескольких экземпляров API сервера на разных портах
   - Настроен Nginx в качестве балансировщика нагрузки (на порту 80)
   - Реализовано ip_hash распределение для сохранения сессий

2. Добавлено динамическое определение оптимального количества экземпляров сервера:
   - Автоматический расчет на основе количества логических ядер CPU
   - Возможность ручного переопределения количества серверов
   - Автоматическая генерация конфигурации Nginx

3. Реализовано автоматическое масштабирование на основе нагрузки:
   - Мониторинг загрузки CPU
   - Автоматическое увеличение/уменьшение количества серверов
   - Настраиваемые пороги и интервалы проверки

4. Созданы вспомогательные скрипты и документация:
   - `start_multiple_servers.bat` - запуск нескольких экземпляров сервера
   - `start_load_balanced_system.bat` - запуск всей системы
   - `dynamic_server_monitor.bat` - монитор нагрузки для автомасштабирования
   - Подробная документация с инструкциями

### Результат
Система теперь способна обрабатывать запросы от большого количества MT4 терминалов одновременно, эффективно распределяя нагрузку между несколькими экземплярами сервера и динамически масштабируясь в зависимости от интенсивности использования.

## 01.06.2023 - Перенос настроек режима работы API (прокси/директ) в основной раздел настроек плагина

### Проблема
Настройки режима работы API (прокси/директ) находились в отдельном разделе административной панели WordPress "Настройки → Настройки API конкурсов", что затрудняло их обнаружение и усложняло конфигурацию плагина для администраторов.

### Решение
Настройки режима работы API (прокси/директ) перенесены в основной раздел настроек плагина "Конкурсы трейдеров → Настройки".

Внесены изменения в файлы:

1. **PLUGIN/contests/admin/class-settings-page.php**:
   - Добавлена новая секция "Настройки режима работы API" в основном разделе настроек
   - Добавлены поля для выбора режима API (прокси/директ)
   - Добавлены поля для настройки IP-адреса и порта SERVERAPI при использовании прямого режима
   - Добавлена кнопка проверки соединения с SERVERAPI
   - Реализован AJAX-обработчик для проверки соединения

2. **PLUGIN/contests/includes/class-api-config.php**:
   - Оставлен без изменений для обеспечения обратной совместимости
   - Класс продолжает корректно работать с перенесенными настройками благодаря использованию функций get_option()

### Технические детали
1. В секции настроек добавлены:
   - Выпадающий список для выбора режима API ("Через WebAPI" или "Прямое подключение к SERVERAPI")
   - Поля ввода для IP-адреса и порта сервера (отображаются только при выборе режима "Прямое подключение")
   - JavaScript для динамического отображения/скрытия полей настроек сервера
   - Кнопка проверки соединения с SERVERAPI с AJAX-обработчиком
   - Визуальное отображение результата проверки соединения

2. Внесены соответствующие дополнения в документацию, отражающие изменения в интерфейсе настроек.

### Автор исправления
Исправление внесено: 01.06.2023