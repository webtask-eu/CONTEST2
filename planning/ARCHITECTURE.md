# Описание архитектуры (ARCHITECTURE.md)

Этот документ описывает архитектуру проекта CONTEST2, включая его основные компоненты и их взаимодействие.

## Компоненты системы

1.  **MT4CONTESTSCRIPT (MQL4)**
    *   Отвечает за экспорт данных из MetaTrader 4.
    *   Взаимодействует с SERVERAPI.

2.  **SERVERAPI (Python/Flask)**
    *   Центральный сервер для обработки данных от MT4.
    *   Предоставляет API для PLUGIN и WEBAPI.
    *   Сохраняет данные в базу данных (например, SQLite, PostgreSQL).

3.  **WEBAPI (PHP)**
    *   Опциональный промежуточный слой (прокси) между PLUGIN и SERVERAPI.
    *   Обеспечивает дополнительный уровень безопасности и кэширования.

4.  **PLUGIN (WordPress)**
    *   Интерфейс пользователя для управления конкурсами.
    *   Отображение рейтингов, регистрация участников.
    *   Взаимодействует либо с WEBAPI (стандартный режим), либо напрямую с SERVERAPI (оптимизированный режим).

## Схема взаимодействия

См. `documentation.md` для детальных схем взаимодействия.

## База данных

- Описание структуры базы данных...

## Ключевые решения и паттерны

- Описание используемых паттернов проектирования (например, MVC, RESTful API).
- Обоснование выбора технологий.

# Архитектура проекта CONTEST2

## Общий обзор архитектуры

Проект CONTEST2 использует распределенную многоуровневую архитектуру, состоящую из четырех основных компонентов:

1. **Терминал MetaTrader 4 с MQL4-скриптами** (MT4CONTESTSCRIPT)
2. **Серверное API на Python/Flask** (SERVERAPI)
3. **PHP-прокси API** (WEBAPI)
4. **WordPress-плагин** (PLUGIN)

### Диаграмма взаимодействия компонентов

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│                 │     │                 │     │                 │     │                 │
│  MetaTrader 4   │     │   Python API    │     │    PHP API      │     │   WordPress     │
│  (MQL4 скрипты) │     │    (Flask)      │     │    (Прокси)     │     │    (Плагин)     │
│                 │     │                 │     │                 │     │                 │
└────────┬────────┘     └────────┬────────┘     └────────┬────────┘     └────────┬────────┘
         │                       │                       │                       │
         │                       │                       │                       │
         │   HTTP запросы        │    Внутренние         │    AJAX/REST          │
         ├──────────────────────►│    запросы           │    запросы            │
         │                       ├──────────────────────►├──────────────────────►│
         │                       │                       │                       │
         │   Ответы с данными    │    Ответы            │    JSON-ответы        │
         │◄──────────────────────┤    с данными         │◄──────────────────────┤
         │                       │◄──────────────────────┤                       │
         │                       │                       │                       │
         ▼                       ▼                       ▼                       ▼
```

## Детальное описание компонентов

### 1. MT4CONTESTSCRIPT (MetaTrader 4)

**Роль**: Сбор и отправка данных о торговых счетах и операциях.

**Ключевые особенности**:
- Скрипт `AccountInfoExport2.mq4` запускается периодически в терминале MT4
- Отправляет HTTP-запросы на Python-сервер с данными о счете и сделках
- Собирает данные о балансе, средствах, марже, открытых и закрытых ордерах
- Контролирует статус подключения к торговому серверу
- Работает как в реальном времени, так и в асинхронном режиме

### 2. SERVERAPI (Python Flask)

**Роль**: Основной сервер обработки данных.

**Структура**:
- `/app/routes.py` - API-маршруты
- `/app/mt4_handler.py` - Обработчики данных MT4
- `/app/account_manager.py` - Управление счетами
- `/app/orders.py` - Работа с ордерами
- `/app/__init__.py` - Инициализация Flask-приложения
- `/app/config.py` - Конфигурация приложения
- `/wsgi.py` - Точка входа WSGI-сервера

**API-маршруты**:
- `POST /api/mt4/update` - Обновление данных счета
- `GET /api/account/info/{account_id}` - Получение информации о счете
- `GET /api/account/history/{account_id}` - История счета
- `GET /api/orders/{account_id}` - Получение открытых ордеров
- `GET /api/orders/history/{account_id}` - История ордеров

### 3. WEBAPI (PHP-прокси)

**Роль**: Прокси-слой для унификации интерфейсов и форматирования ответов.

**Ключевые файлы**:
- `api.php` - Основной API-эндпоинт (текстовый формат)
- `api_json.php` - API с JSON-форматированием
- `api_json_wp.php` - API для WordPress с JSON-форматированием
- `api_old.php` - API для обратной совместимости
- `config.ini` - Файл конфигурации

**Функциональность**:
- Принимает HTTP-запросы от клиентов
- Перенаправляет запросы на Python-сервер через curl
- Форматирует ответы (текст, JSON, JSON для WordPress)
- Не хранит данные локально и не взаимодействует напрямую с БД

### 4. PLUGIN (WordPress)

**Роль**: Управление конкурсами, отображение данных, взаимодействие с пользователями.

**Структура**:
- `admin/` - Административный интерфейс
- `frontend/` - Публичная часть
- `includes/` - Бизнес-логика и обработчики
- `public/` - Публичные скрипты и стили
- `templates/` - Шаблоны страниц
- `ft-trader-contest.php` - Основной файл плагина

**Основные классы**:
- `Account_Manager` - Управление счетами
- `Account_History` - История счета
- `Account_Trading_Metrics` - Расчет торговых метрик
- `Orders_Manager` - Управление ордерами
- `Contest_Manager` - Управление конкурсами
- `API_Handler` - Обработчик API-запросов

## Схема базы данных

WordPress-плагин использует следующие таблицы в базе данных:

### Таблица `wp_contest_members`
Хранит информацию о счетах участников конкурса.

**Основные поля:**
- `id` - ID записи
- `user_id` - ID пользователя WordPress
- `account_number` - Номер торгового счета
- `contest_id` - ID конкурса
- `balance` - Баланс счета
- `equity` - Средства счета
- `margin` - Маржа
- `profit` - Прибыль
- `margin_level` - Уровень маржи
- `orders_total` - Количество открытых ордеров
- `connection_status` - Статус подключения
- `last_update` - Время последнего обновления

### Таблица `wp_contest_members_orders`
Хранит текущие открытые ордера.

**Основные поля:**
- `id` - ID записи
- `account_id` - ID счета
- `order_number` - Номер ордера
- `order_type` - Тип ордера (BUY/SELL)
- `symbol` - Торговый инструмент
- `volume` - Объем в лотах
- `open_price` - Цена открытия
- `open_time` - Время открытия
- `profit` - Текущая прибыль/убыток

### Таблица `wp_contest_members_order_history`
Хранит историю закрытых ордеров.

**Основные поля:**
- `id` - ID записи
- `account_id` - ID счета
- `order_number` - Номер ордера
- `order_type` - Тип ордера (BUY/SELL)
- `symbol` - Торговый инструмент
- `volume` - Объем в лотах
- `open_price` - Цена открытия
- `open_time` - Время открытия
- `close_price` - Цена закрытия
- `close_time` - Время закрытия
- `profit` - Прибыль/убыток

### Таблица `wp_contest_members_history`
Хранит историю изменений различных полей счета.

**Основные поля:**
- `id` - ID записи
- `account_id` - ID счета
- `field_name` - Название поля (`i_bal`, `i_equi`, и т.д.)
- `field_value` - Значение поля
- `timestamp` - Время записи

## Потоки данных

1. **Обновление данных счета**:
   - MT4 скрипт собирает данные и отправляет на SERVERAPI
   - SERVERAPI обрабатывает, проверяет и сохраняет данные
   - PLUGIN периодически запрашивает обновления через WEBAPI
   - Данные отображаются в интерфейсе WordPress

2. **Добавление нового счета**:
   - Пользователь регистрирует счет через форму в PLUGIN
   - PLUGIN отправляет запрос на WEBAPI
   - WEBAPI перенаправляет запрос на SERVERAPI
   - SERVERAPI регистрирует счет и начинает мониторинг
   - MT4 скрипт подключается к счету и начинает отправку данных

3. **Просмотр истории сделок**:
   - Пользователь запрашивает историю через интерфейс PLUGIN
   - PLUGIN отправляет AJAX-запрос на WEBAPI
   - WEBAPI перенаправляет запрос на SERVERAPI
   - SERVERAPI извлекает данные и возвращает результат
   - PLUGIN отображает данные в таблице или графике

## Безопасность

1. **Аутентификация и авторизация**:
   - WordPress-пользователи используют стандартные механизмы WP
   - API-запросы используют API-ключи или токены сессии
   - MT4-скрипты используют специальные ключи для API

2. **Защита данных**:
   - Валидация и санитизация всех входных данных
   - Подготовленные запросы для работы с БД
   - HTTPS для передачи данных между компонентами

3. **Изоляция компонентов**:
   - WEBAPI изолирует SERVERAPI от прямого доступа
   - PLUGIN ограничивает доступ пользователей только к своим данным
   - MT4-скрипты работают только с назначенными счетами 