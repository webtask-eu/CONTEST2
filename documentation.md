# Документация проекта CONTEST2

## Описание проекта

CONTEST2 — комплексная система для проведения конкурсов трейдеров на платформе MetaTrader 4 с интеграцией через WordPress-плагин, серверный API и веб-интерфейс.

## Компоненты системы

### 1. MT4CONTESTSCRIPT

Скрипты на языке MQL4 для платформы MetaTrader 4, отвечающие за экспорт данных о торговых счетах и сделках.

Основные файлы:
- `AccountInfoExport2.mq4` - главный скрипт для экспорта информации о счетах и сделках

### 2. PLUGIN (WordPress)

WordPress-плагин для управления конкурсами трейдеров, отображения рейтингов, регистрации участников.

Структура плагина:
- `contests/` - Директория с основным кодом плагина
  - `admin/` - Административный интерфейс
  - `frontend/` - Публичная часть
  - `includes/` - Основные классы и функции
  - `public/` - Публичные скрипты и стили
  - `templates/` - Шаблоны для отображения
  - `ft-trader-contest.php` - Основной файл плагина

Подробная документация плагина доступна в файле `PLUGIN/contests/documentation.md`.

### 3. SERVERAPI (Python Flask)

Серверное приложение на Python (Flask), обрабатывающее запросы от MT4-скриптов и WordPress-плагина.

Основные файлы:
- `app/` - Директория с кодом сервера
  - `routes.py` - Маршруты API
  - `__init__.py` - Инициализация приложения
  - `config.py` - Конфигурация
- `wsgi.py` - Точка входа для WSGI-сервера
- `mt4_balancer.py` - Балансировщик нагрузки для MT4 терминалов

#### 3.1. Балансировщик MT4 терминалов

С версии 2.0 SERVERAPI включает в себя балансировщик нагрузки, который решает проблему параллельного запуска нескольких терминалов MT4. Балансировщик:

1. Запускает отдельный изолированный инстанс Python-сервера для каждого MT4 терминала
2. Перенаправляет запросы на соответствующий инстанс по уникальному идентификатору терминала
3. Автоматически останавливает неактивные инстансы
4. Предотвращает конфликты между терминалами

Запуск балансировщика:
```bash
python wsgi.py --mode balancer
```

Подробная документация балансировщика доступна в файле `SERVERAPI/planning/BALANCER_USAGE.md`.

### Обработка статусов соединения в SERVERAPI

Система SERVERAPI различает несколько статусов соединения с MT4:

1. **Таймаут** - происходит, когда MT4 не отвечает в течение определенного времени (60 секунд).
   - Увеличивает внутренний счетчик таймаутов.
   - При достижении лимита таймаутов (настройка `MAX_MT4_TIMEOUTS`) производится перезагрузка сервера.

2. **Disconnected** - происходит, когда MT4 явно сообщает о потере соединения, отправляя статус "disconnected".
   - Не увеличивает счетчик таймаутов.
   - Логирует информацию об ошибке.
   - Освобождает ресурсы (закрывает терминал MT4, удаляет временные директории).

### Особенности работы MT4 скрипта

Скрипт MT4 (AccountInfoExport2.mq4) имеет следующие особенности:

1. **Отсутствие попыток переподключения** - при потере соединения скрипт немедленно отправляет статус "disconnected" на сервер и завершает работу.
   - Параметр `max_reconnect_attempts` установлен в 0.
   - Функция `TryReconnect()` сразу сообщает об ошибке подключения без попыток переподключения.
   - Это позволяет уменьшить нагрузку на сервер при параллельных запусках и избежать накопления "подвисших" процессов.

2. **Отправка данных о состоянии счета** - скрипт собирает и отправляет информацию о:
   - Балансе, средствах, свободной марже и прибыли
   - Открытых позициях
   - Истории ордеров
   - Информации о счете и торговом сервере

Важно: Статусы "таймаут" и "disconnected" обрабатываются раздельно и имеют разные последствия для системы.

### 4. WEBAPI (PHP)

Набор PHP-скриптов, выполняющих функции прокси между сервером на Python и внешними клиентами.

Основные файлы:
- `api.php` - Основной API-эндпоинт
- `api_json.php` - API для JSON-ответов
- `api_json_wp.php` - API для WordPress с JSON-форматированием
- `api_old.php` - API для обратной совместимости
- `config.ini` - Файл конфигурации

## Схема взаимодействия компонентов

### Стандартный режим (через WebAPI)

```
  ┌───────────────────────────────────────────────────────────────┐
  │                  ▼  (1. Данные, события, команды)             │
  │  MT4CONTESTSCRIPT   ⇄   SERVERAPI   ⇄   WEBAPI   ⇄   PLUGIN  │
  │    (MT4)            ⇄   (Python)    ⇄   (PHP)    ⇄ (WordPress│
  │                  ▲  (2. Ответ, результат, обновления)         │
  └───────────────────────────────────────────────────────────────┘
```

### Оптимизированный режим (прямое подключение)

```
  ┌─────────────────────────────────────────┐
  │            ▼  (1. Данные)               │
  │  MT4CONTESTSCRIPT   ⇄   SERVERAPI   ⇄   PLUGIN  │
  │    (MT4)            ⇄   (Python)    ⇄  (WordPress) │
  │            ▲  (2. Ответ)                │
  └─────────────────────────────────────────┘
```

1. **MT4CONTESTSCRIPT (MetaTrader 4)** экспортирует данные о счетах и сделках, отправляя их на Python-сервер.
2. **SERVERAPI (Python Flask)**:
   - Обрабатывает и сохраняет данные от MT4
   - Предоставляет API как для WebAPI, так и для WordPress плагина напрямую
   - В оптимизированном режиме самостоятельно форматирует данные для WordPress

3. **WEBAPI (PHP)** - опциональный промежуточный слой:
   - Служит прокси между WordPress и SERVERAPI
   - Может быть исключен из схемы при использовании оптимизированного режима

4. **PLUGIN (WordPress)**:
   - В стандартном режиме: выполняет запросы к WebAPI
   - В оптимизированном режиме: выполняет запросы напрямую к SERVERAPI
   - Поддерживает переключение между режимами через админ-панель

## Настройка режима API в WordPress плагине

WordPress плагин поддерживает два режима подключения к API:

1. **Стандартный режим (через WebAPI)**:
   - Использует промежуточный слой WebAPI (tradingapi.intellarax.com)
   - Обеспечивает обратную совместимость с существующими решениями

2. **Оптимизированный режим (прямое подключение)**:
   - Подключается напрямую к SERVERAPI, минуя промежуточный слой
   - Обеспечивает меньшие задержки и более высокую надежность

### Настройка режима:

1. В админ-панели WordPress перейдите в раздел **Настройки → Настройки API конкурсов**
2. Выберите нужный режим:
   - **Через WebAPI** - для стандартного подключения
   - **Прямое подключение к SERVERAPI** - для оптимизированного подключения
3. При выборе прямого подключения укажите:
   - **IP-адрес сервера** - где запущен SERVERAPI
   - **Порт** - обычно 80 для HTTP или 443 для HTTPS
4. Нажмите кнопку **Проверить соединение** для подтверждения работоспособности

Примечание: для работы оптимизированного режима требуется прямой доступ к SERVERAPI из сети, где размещен WordPress сайт.

## Установка и настройка

### Требования
- Python 3.8+
- WordPress 5.0+
- PHP 7.4+
- MetaTrader 4

### Установка компонентов

1. **MT4CONTESTSCRIPT**
   - Скомпилировать файл `AccountInfoExport2.mq4` в MetaEditor
   - Установить в директорию Experts или Scripts терминала MT4

2. **SERVERAPI**
   - Установить зависимости: `pip install -r requirements.txt`
   - Запустить сервер: `python wsgi.py`

3. **WEBAPI**
   - Разместить файлы на PHP-сервере
   - Настроить `config.ini` для соединения с SERVERAPI

4. **PLUGIN**
   - Скопировать директорию `contests/` в `wp-content/plugins/`
   - Активировать плагин через админ-панель WordPress

## Документация разработки

Подробная документация по разработке хранится в директории `planning/`:
- `BUG_FIXES_LOG.md` - Лог исправлений
- `ARCHITECTURE.md` - Описание архитектуры
- `ROADMAP.md` - План развития
- `CSS_GUIDE.md` - Стандарты CSS

## Диагностика и отладка

Для диагностики и отладки системы можно использовать:
1. Логи MT4 (Experts/Logs)
2. Логи SERVERAPI (стандартный вывод или файлы логов)
3. PHP-логи для WEBAPI
4. Встроенные инструменты отладки в WordPress

## Разработчикам

При внесении изменений в проект следуйте:
1. Стандартам кодирования WordPress
2. Принципам RESTful API для серверной части
3. Логированию всех значимых действий
4. Документированию изменений в соответствующих log-файлах 